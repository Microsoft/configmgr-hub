<sequence version="3.10">
  <group name="Gather" description="Basic Gather TS. Outputs: _SMSTSMake _SMSTSModel _SMSTSMacAddresses _SMSTSIPAddresses _SMSTSSerialNumber _SMSTSAssetTag _SMSTSUUID ChassisType IsVM IsLaptop IsDesktop IsServer">
    <step type="SMS_TaskSequence_SetDynamicVariablesAction" name="Setup Gather Variables" description="Set default values for all of the gather variables. This is optional but will ensure that variables have a value and don't get returned as %IsVM% in the logs when they don't already exist." runIn="WinPEandFullOS" successCodeList="0" retryCount="0" runFromNet="false">
      <action>OSDSetDynamicVariables.exe</action>
      <defaultVarList>
        <variable name="OSDSetDynamicVariablesRules" property="Rules">&lt;Rules&gt;&lt;Rule&gt;&lt;Variables&gt;&lt;Variable Name="ChassisType" IsSecret="false"&gt;Unknown&lt;/Variable&gt;&lt;/Variables&gt;&lt;/Rule&gt;&lt;Rule&gt;&lt;Variables&gt;&lt;Variable Name="IsVM" IsSecret="false"&gt;False&lt;/Variable&gt;&lt;/Variables&gt;&lt;/Rule&gt;&lt;Rule&gt;&lt;Variables&gt;&lt;Variable Name="IsDesktop" IsSecret="false"&gt;False&lt;/Variable&gt;&lt;/Variables&gt;&lt;/Rule&gt;&lt;Rule&gt;&lt;Variables&gt;&lt;Variable Name="IsLaptop" IsSecret="false"&gt;False&lt;/Variable&gt;&lt;/Variables&gt;&lt;/Rule&gt;&lt;Rule&gt;&lt;Variables&gt;&lt;Variable Name="IsServer" IsSecret="false"&gt;False&lt;/Variable&gt;&lt;/Variables&gt;&lt;/Rule&gt;&lt;/Rules&gt;
</variable>
      </defaultVarList>
    </step>
    <step type="SMS_TaskSequence_RunPowerShellScriptAction" name="Get Clean Serial Number" description="" runIn="WinPEandFullOS" successCodeList="0 3010" retryCount="0" runFromNet="false">
      <action>OSDRunPowerShellScript.exe</action>
      <defaultVarList>
        <variable name="OSDRunPowerShellScriptExecutionPolicy" property="ExecutionPolicy">Bypass</variable>
        <variable name="OSDRunPowerShellScriptOutputVariableName" property="OutputVariableName">ComputerSerialNumber</variable>
        <variable name="OSDRunPowerShellScriptParameters" property="Parameters"></variable>
        <variable name="_SMSTSRunPowerShellAsUser" property="RunAsUser">false</variable>
        <variable name="OSDRunPowerShellScriptSourceScript" property="SourceScript">//5bAGMAbQBkAGwAZQB0AGIAaQBuAGQAaQBuAGcAKAApAF0ADQAKAHAAYQByAGEAbQAgACgAKQANAAoADQAKAHQAcgB5ACAAewANAAoAIAAgACAAIAAkAEIASQBPAFMAIAA9ACAARwBlAHQALQBDAGkAbQBJAG4AcwB0AGEAbgBjAGUAIAAtAE4AYQBtAGUAcwBwAGEAYwBlACAAIgBSAE8ATwBUAFwAQwBpAG0AdgAyACIAIAAtAEMAbABhAHMAcwAgACIAVwBpAG4AMwAyAF8AQgBJAE8AUwAiACAALQBFAHIAcgBvAHIAQQBjAHQAaQBvAG4AIABTAHQAbwBwAA0ACgAgACAAIAAgACQAUwBlAHIAaQBhAGwATgB1AG0AYgBlAHIAIAA9ACAAJABCAEkATwBTAC4AUwBlAHIAaQBhAGwATgB1AG0AYgBlAHIALgBSAGUAcABsAGEAYwBlACgAJwAgACcALAAnACcAKQANAAoAIAAgACAAIABpAGYAIAAoACQAQgBJAE8AUwAuAE0AYQBuAHUAZgBhAGMAdAB1AHIAZQByACAALQBsAGkAawBlACAAIgAqAE0AaQBjAHIAbwBzAG8AZgB0ACoAIgApACAAewAgACMAdAByAGkAbQAgAHQAaABlACAAdAByAGEAaQBsAGkAbgBnACAANAAgAGMAaABhAHIAcwAgAHMAaQBuAGMAZQAgAHQAaABlAHkAIABhAHIAZQAgAHQAaABlACAAcwBhAG0AZQAgAGEAYwByAG8AcwBzACAAbQBvAHMAdAAgAG0AbwBkAGUAbABzAC4AIABQAGUAcgAgAE0AaQBjAHIAbwBzAG8AZgB0AC4ALgAuAA0ACgAgACAAIAAgACAAIAAgACAAJABDAGgAYQByAHMAVABvAFQAcgBpAG0AIAA9ACAAJABTAGUAcgBpAGEAbABOAHUAbQBiAGUAcgAuAEwAZQBuAGcAdABoACAALQAgADgADQAKACAAIAAgACAAIAAgACAAIAAkAFMAZQByAGkAYQBsAE4AdQBtAGIAZQByACAAPQAgACQAUwBlAHIAaQBhAGwATgB1AG0AYgBlAHIALgBTAHUAYgBzAHQAcgBpAG4AZwAoADAALAAkAFMAZQByAGkAYQBsAE4AdQBtAGIAZQByAC4ATABlAG4AZwB0AGgAIAAtACAAJABDAGgAYQByAHMAVABvAFQAcgBpAG0AKQANAAoAIAAgACAAIAB9AA0ACgAgACAAIAAgAGUAbABzAGUAaQBmACAAKAAkAFMAZQByAGkAYQBsAE4AdQBtAGIAZQByAC4ATABlAG4AZwB0AGgAIAAtAGcAdAAgADgAKQAgAHsADQAKACAAIAAgACAAIAAgACAAIAAkAEMAaABhAHIAcwBUAG8AVAByAGkAbQAgAD0AIAAkAFMAZQByAGkAYQBsAE4AdQBtAGIAZQByAC4ATABlAG4AZwB0AGgAIAAtACAAOAANAAoAIAAgACAAIAAgACAAIAAgACQAUwBlAHIAaQBhAGwATgB1AG0AYgBlAHIAIAA9ACAAJABTAGUAcgBpAGEAbABOAHUAbQBiAGUAcgAuAHIAZQBtAG8AdgBlACgAMAAsACQAQwBoAGEAcgBzAFQAbwBUAHIAaQBtACkADQAKACAAIAAgACAAfQANAAoAIAAgACAAIAByAGUAdAB1AHIAbgAgACQAUwBlAHIAaQBhAGwATgB1AG0AYgBlAHIALgBUAG8AVQBwAHAAZQByACgAKQANAAoAfQANAAoAYwBhAHQAYwBoACAAewANAAoAIAAgACAAIAByAGUAdAB1AHIAbgAgACQAXwANAAoAfQA=</variable>
        <variable name="OSDRunPowerShellScriptSuccessCodes" property="SuccessCodes" hidden="true">0 3010</variable>
        <variable name="SMSTSRunPowerShellUserName" property="UserName"></variable>
        <variable name="SMSTSRunPowerShellWorkingDirectory" property="WorkingDirectory"></variable>
      </defaultVarList>
    </step>
    <step type="SMS_TaskSequence_RunPowerShellScriptAction" name="Get ChassisType" description="Use Powershell to get the chassis type https://docs.microsoft.com/en-us/mem/configmgr/mdt/toolkit-reference#IsLaptop" runIn="WinPEandFullOS" successCodeList="0 3010" retryCount="0" runFromNet="false">
      <action>OSDRunPowerShellScript.exe</action>
      <defaultVarList>
        <variable name="OSDRunPowerShellScriptExecutionPolicy" property="ExecutionPolicy">Bypass</variable>
        <variable name="OSDRunPowerShellScriptOutputVariableName" property="OutputVariableName">ChassisType</variable>
        <variable name="OSDRunPowerShellScriptParameters" property="Parameters"></variable>
        <variable name="_SMSTSRunPowerShellAsUser" property="RunAsUser">false</variable>
        <variable name="OSDRunPowerShellScriptSourceScript" property="SourceScript">//5bAGMAbQBkAGwAZQB0AGIAaQBuAGQAaQBuAGcAKAApAF0ADQAKAHAAYQByAGEAbQAoAA0ACgAgACAAIAAgAFsAaQBuAHQAWwBdAF0AJAB0AHkAcABlAHMADQAKACkADQAKAFQAcgB5ACAAewANAAoAIAAgACAAIAAjAEMAaABhAHMAcwBpAHMAIABUAHkAcABlACAATABpAHMAdAANAAoAIAAgACAAIABbAGkAbgB0AFsAXQBdACQATABhAHAAdABvAHAAIAA9ACAAQAAoADgALAAgADkALAAgADEAMAAsACAAMQAxACwAIAAxADIALAAgADEANAAsACAAMQA4ACwAIAAyADEALAAgADMAMAAsACAAMwAxACwAIAAzADIAKQANAAoAIAAgACAAIABbAGkAbgB0AFsAXQBdACQARABlAHMAawB0AG8AcAAgAD0AIABAACgAMwAsACAANAAsACAANQAsACAANgAsACAANwAsACAAMQAzACwAIAAxADUALAAgADEANgAsACAAMwA1ACwAIAAzADYAKQANAAoAIAAgACAAIABbAGkAbgB0AFsAXQBdACQAUwBlAHIAdgBlAHIAIAA9ACAAQAAoADIAMwAsACAAMgA4ACkADQAKAA0ACgAgACAAIAAgACMAUwBlAHQAIABhACAAZABlAGYAYQB1AGwAdAAgAGkAbgAgAGMAYQBzAGUAIAB0AGgAZQAgAHMAYwByAGkAcAB0ACAAZgBhAGkAbABzAA0ACgAgACAAIAAgACQAQwBoAGEAcwBzAGkAcwBUAHkAcABlAHMAIAA9ACAAIgBVAG4AawBuAG8AdwBuACIADQAKAA0ACgAgACAAIAAgAEkAZgAoAC0AbgBvAHQAIAAkAHQAeQBwAGUAcwApACAAewANAAoAIAAgACAAIAAgACAAIAAgACQAQwBJAE0AQwBoAGEAcwBzAGkAcwBUAHkAcABlACAAPQAgAEcAZQB0AC0AQwBJAE0ASQBuAHMAdABhAG4AYwBlACAALQBOAGEAbQBlAHMAcABhAGMAZQAgACIAUgBPAE8AVABcAGMAaQBtAHYAMgAiACAALQBDAGwAYQBzAHMATgBhAG0AZQAgACIAVwBpAG4AMwAyAF8AUwB5AHMAdABlAG0ARQBuAGMAbABvAHMAdQByAGUAIgAgAC0ARQByAHIAbwByAEEAYwB0AGkAbwBuACAAUwB0AG8AcAANAAoAIAAgACAAIAAgACAAIAAgAFsAaQBuAHQAWwBdAF0AJAB0AHkAcABlAHMAIAA9ACAAJABDAEkATQBDAGgAYQBzAHMAaQBzAFQAeQBwAGUALgBDAGgAYQBzAHMAaQBzAFQAeQBwAGUAcwANAAoAIAAgACAAIAB9AA0ACgANAAoAIAAgACAAIABJAGYAKAAkAHQAeQBwAGUAcwApACAAewANAAoAIAAgACAAIAAgACAAIAAgAFsAcwB0AHIAaQBuAGcAWwBdAF0AJABDAGgAYQBzAHMAaQBzAFQAeQBwAGUAcwAgAD0AIABGAG8AcgBFAGEAYwBoACgAJAB0AHkAcABlACAAaQBuACAAJAB0AHkAcABlAHMAKQAgAHsADQAKACAAIAAgACAAIAAgACAAIAAgACAAIAAgAFMAdwBpAHQAYwBoACgAJAB0AHkAcABlACkAIAB7AA0ACgAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAHsAJABMAGEAcAB0AG8AcAAgAC0AZQBxACAAJABfAH0AIAB7ACIATABhAHAAdABvAHAAIgA7ACAAYgByAGUAYQBrADsAfQANAAoAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAB7ACQARABlAHMAawB0AG8AcAAgAC0AZQBxACAAJABfAH0AIAB7ACIARABlAHMAawB0AG8AcAAiADsAIABiAHIAZQBhAGsAOwB9AA0ACgAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAHsAJABTAGUAcgB2AGUAcgAgAC0AZQBxACAAJABfAH0AIAB7ACIAUwBlAHIAdgBlAHIAIgA7ACAAYgByAGUAYQBrADsAfQANAAoAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIABkAGUAZgBhAHUAbAB0ACAAewAiAFUAbgBrAG4AbwB3AG4AIgA7ACAAYgByAGUAYQBrADsAfQANAAoAIAAgACAAIAAgACAAIAAgACAAIAAgACAAfQANAAoAIAAgACAAIAAgACAAIAAgAH0ADQAKACAAIAAgACAAfQANAAoADQAKACAAIAAgACAAUgBlAHQAdQByAG4AIAAoACQAQwBoAGEAcwBzAGkAcwBUAHkAcABlAHMAIAB8ACAAUwBlAGwAZQBjAHQALQBPAGIAagBlAGMAdAAgAC0AVQBuAGkAcQB1AGUAKQAgAC0AagBvAGkAbgAgACgAIgAsACIAKQANAAoAfQANAAoAQwBhAHQAYwBoACAAewANAAoAIAAgACAAIABSAGUAdAB1AHIAbgAgACQAQwBoAGEAcwBzAGkAcwBUAHkAcABlAHMADQAKAH0A</variable>
        <variable name="OSDRunPowerShellScriptSuccessCodes" property="SuccessCodes" hidden="true">0 3010</variable>
      </defaultVarList>
    </step>
    <step type="SMS_TaskSequence_SetDynamicVariablesAction" name="Gather" description="Set variables based on Make, Model and ChassisType. https://docs.microsoft.com/en-us/mem/configmgr/mdt/toolkit-reference#IsVM" runIn="WinPEandFullOS" successCodeList="0" retryCount="0" runFromNet="false">
      <action>OSDSetDynamicVariables.exe</action>
      <defaultVarList>
        <variable name="OSDSetDynamicVariablesRules" property="Rules">&lt;Rules&gt;&lt;Rule&gt;&lt;condition&gt;&lt;expression type="SMS_TaskSequence_MakeModelConditionExpression"&gt;&lt;variable name="Make"&gt;*&lt;/variable&gt;&lt;variable name="Model"&gt;*VMware*&lt;/variable&gt;&lt;/expression&gt;&lt;/condition&gt;&lt;Variables&gt;&lt;Variable Name="IsVM" IsSecret="false"&gt;True&lt;/Variable&gt;&lt;Variable Name="VMPlatform" IsSecret="false"&gt;VMware&lt;/Variable&gt;&lt;/Variables&gt;&lt;/Rule&gt;&lt;Rule&gt;&lt;condition&gt;&lt;expression type="SMS_TaskSequence_MakeModelConditionExpression"&gt;&lt;variable name="Make"&gt;*VMware*&lt;/variable&gt;&lt;variable name="Model"&gt;*&lt;/variable&gt;&lt;/expression&gt;&lt;/condition&gt;&lt;Variables&gt;&lt;Variable Name="IsVM" IsSecret="false"&gt;True&lt;/Variable&gt;&lt;Variable Name="VMPlatform" IsSecret="false"&gt;VMware&lt;/Variable&gt;&lt;/Variables&gt;&lt;/Rule&gt;&lt;Rule&gt;&lt;condition&gt;&lt;expression type="SMS_TaskSequence_MakeModelConditionExpression"&gt;&lt;variable name="Make"&gt;*&lt;/variable&gt;&lt;variable name="Model"&gt;Virtual Machine&lt;/variable&gt;&lt;/expression&gt;&lt;/condition&gt;&lt;Variables&gt;&lt;Variable Name="IsVM" IsSecret="false"&gt;True&lt;/Variable&gt;&lt;Variable Name="VMPlatform" IsSecret="false"&gt;VirtualBox&lt;/Variable&gt;&lt;/Variables&gt;&lt;/Rule&gt;&lt;Rule&gt;&lt;condition&gt;&lt;expression type="SMS_TaskSequence_MakeModelConditionExpression"&gt;&lt;variable name="Make"&gt;*&lt;/variable&gt;&lt;variable name="Model"&gt;VirtualBox&lt;/variable&gt;&lt;/expression&gt;&lt;/condition&gt;&lt;Variables&gt;&lt;Variable Name="IsVM" IsSecret="false"&gt;True&lt;/Variable&gt;&lt;Variable Name="VMPlatform" IsSecret="false"&gt;VirtualBox&lt;/Variable&gt;&lt;/Variables&gt;&lt;/Rule&gt;&lt;Rule&gt;&lt;condition&gt;&lt;expression type="SMS_TaskSequence_MakeModelConditionExpression"&gt;&lt;variable name="Make"&gt;*&lt;/variable&gt;&lt;variable name="Model"&gt;Xen&lt;/variable&gt;&lt;/expression&gt;&lt;/condition&gt;&lt;Variables&gt;&lt;Variable Name="IsVM" IsSecret="false"&gt;True&lt;/Variable&gt;&lt;Variable Name="VMPlatform" IsSecret="false"&gt;Xen&lt;/Variable&gt;&lt;/Variables&gt;&lt;/Rule&gt;&lt;Rule&gt;&lt;condition&gt;&lt;expression type="SMS_TaskSequence_MakeModelConditionExpression"&gt;&lt;variable name="Make"&gt;PARALLELS&lt;/variable&gt;&lt;variable name="Model"&gt;*&lt;/variable&gt;&lt;/expression&gt;&lt;/condition&gt;&lt;Variables&gt;&lt;Variable Name="IsVM" IsSecret="false"&gt;True&lt;/Variable&gt;&lt;Variable Name="VMPlatform" IsSecret="false"&gt;PARALLELS&lt;/Variable&gt;&lt;/Variables&gt;&lt;/Rule&gt;&lt;Rule&gt;&lt;condition&gt;&lt;expression type="SMS_TaskSequence_VariableConditionExpression"&gt;&lt;variable name="Operator"&gt;equals&lt;/variable&gt;&lt;variable name="Value"&gt;Laptop&lt;/variable&gt;&lt;variable name="Variable"&gt;ChassisType&lt;/variable&gt;&lt;/expression&gt;&lt;/condition&gt;&lt;Variables&gt;&lt;Variable Name="IsLaptop" IsSecret="false"&gt;True&lt;/Variable&gt;&lt;/Variables&gt;&lt;/Rule&gt;&lt;Rule&gt;&lt;condition&gt;&lt;expression type="SMS_TaskSequence_VariableConditionExpression"&gt;&lt;variable name="Operator"&gt;equals&lt;/variable&gt;&lt;variable name="Value"&gt;Desktop&lt;/variable&gt;&lt;variable name="Variable"&gt;ChassisType&lt;/variable&gt;&lt;/expression&gt;&lt;/condition&gt;&lt;Variables&gt;&lt;Variable Name="IsDesktop" IsSecret="false"&gt;True&lt;/Variable&gt;&lt;/Variables&gt;&lt;/Rule&gt;&lt;Rule&gt;&lt;condition&gt;&lt;expression type="SMS_TaskSequence_VariableConditionExpression"&gt;&lt;variable name="Operator"&gt;equals&lt;/variable&gt;&lt;variable name="Value"&gt;Server&lt;/variable&gt;&lt;variable name="Variable"&gt;ChassisType&lt;/variable&gt;&lt;/expression&gt;&lt;/condition&gt;&lt;Variables&gt;&lt;Variable Name="IsServer" IsSecret="false"&gt;True&lt;/Variable&gt;&lt;/Variables&gt;&lt;/Rule&gt;&lt;/Rules&gt;
</variable>
      </defaultVarList>
    </step>
    <step type="SMS_TaskSequence_RunCommandLineAction" name="Output Gather Results" description="Echo results so they get logged in smsts.log" runIn="WinPEandFullOS" successCodeList="0 3010" retryCount="0" runFromNet="false">
      <action>smsswd.exe /run: cmd /c echo "_SMSTSMake: %_SMSTSMake%" &amp;&amp; echo "_SMSTSModel: %_SMSTSModel%" &amp;&amp; echo "_SMSTSMacAddresses: %_SMSTSMacAddresses%" &amp;&amp; echo "_SMSTSIPAddresses: %_SMSTSIPAddresses%" &amp;&amp; echo "_SMSTSSerialNumber: %_SMSTSSerialNumber%" &amp;&amp; echo "_SMSTSAssetTag: %_SMSTSAssetTag%" &amp;&amp; echo "_SMSTSUUID: %_SMSTSUUID%" &amp;&amp; echo "ChassisType: %ChassisType%" &amp;&amp; echo "IsVM: %IsVM%" &amp;&amp; echo "IsLaptop: %IsLaptop%" &amp;&amp; echo "IsDesktop: %IsDesktop%" &amp;&amp; echo "IsServer: %IsServer%"</action>
      <defaultVarList>
        <variable name="CommandLine" property="CommandLine" hidden="true">cmd /c echo "_SMSTSMake: %_SMSTSMake%" &amp;&amp; echo "_SMSTSModel: %_SMSTSModel%" &amp;&amp; echo "_SMSTSMacAddresses: %_SMSTSMacAddresses%" &amp;&amp; echo "_SMSTSIPAddresses: %_SMSTSIPAddresses%" &amp;&amp; echo "_SMSTSSerialNumber: %_SMSTSSerialNumber%" &amp;&amp; echo "_SMSTSAssetTag: %_SMSTSAssetTag%" &amp;&amp; echo "_SMSTSUUID: %_SMSTSUUID%" &amp;&amp; echo "ChassisType: %ChassisType%" &amp;&amp; echo "IsVM: %IsVM%" &amp;&amp; echo "IsLaptop: %IsLaptop%" &amp;&amp; echo "IsDesktop: %IsDesktop%" &amp;&amp; echo "IsServer: %IsServer%"</variable>
        <variable name="SMSTSDisableWow64Redirection" property="DisableWow64Redirection">false</variable>
        <variable name="SMSTSRunCommandLineOutputVariableName" property="OutputVariableName"></variable>
        <variable name="_SMSTSRunCommandLineAsUser" property="RunAsUser">false</variable>
        <variable name="SuccessCodes" property="SuccessCodes" hidden="true">0 3010</variable>
      </defaultVarList>
    </step>
  </group>
</sequence>