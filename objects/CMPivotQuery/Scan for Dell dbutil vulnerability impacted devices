//CMPivot query to list devices that have the 'dbutil_2_3.sys' Dell driver file in known locations
//as documented in Dell's KB article, and are impacted by the security vulnerability found in that driver.
//https://www.dell.com/support/kbdoc/en-us/000186019/dsa-2021-088-dell-client-platform-security-update-for-dell-driver-insufficient-access-control-vulnerability?lwp=rt

Device
| join kind=leftouter (File('%windir%\\temp\\dbutil_2_3.sys'))
| join kind=leftouter (File('C:\\Users\\*\\appdata\\local\\temp\\dbutil_2_3.sys')) | take 1

//The Users folder isn't always on C: and CMPivot doesn't allow for variables in the File() syntax.
//That is why we include the ProfilesDirectory column; to indicate you might want to check on other drives on that device.
| join kind=leftouter (
	Registry('HKLM:\\Software\\Microsoft\\Windows NT\\CurrentVersion\\ProfileList')
	| where (Property == 'ProfilesDirectory')
  )

| project Device, Manufacturer, Model,
	Impacted = iif( isnull(FileName) and isnull(FileName1), 'No', 'Yes'),
	WindowsTemp = iif(isnotnull(FileName), 'Yes', 'No'),
	UserTemp = iif(isnotnull(FileName1), 'Yes', 'No'),
	ProfilesDirectory = Value